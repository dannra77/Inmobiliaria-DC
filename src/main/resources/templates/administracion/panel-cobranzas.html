<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title th:text="'Cuotas de ' + ${nombreMes} + ' ' + ${anioActual} + ' - DC Inmobiliaria'">Cuotas - DC Inmobiliaria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Mantener todos los estilos del octubre.html original */
        body {
            background-color: #1e1e1e;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding-top: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #2c2c2c;
            padding: 30px;
            border-radius: 12px;
        }
        h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #f5f5f5;
            border-bottom: 2px solid #a75858;
            padding-bottom: 10px;
        }
        .table-container {
            background-color: #363636;
            border-radius: 8px;
            overflow: hidden;
            overflow-x: auto;
        }
        .table {
            margin-bottom: 0;
            color: white;
            min-width: 1200px;
        }
        .table thead th {
            background-color: #a75858;
            border: none;
            color: white;
            font-weight: 600;
            white-space: nowrap;
        }
        .table tbody tr {
            background-color: #3b3b3b;
        }
        .table tbody tr:hover {
            background-color: #4a4a4a;
        }
        .table tbody td {
            border-color: #5a5a5a;
            vertical-align: middle;
            white-space: nowrap;
        }
        .btn-primary {
            background-color: #a75858;
            border: none;
            min-width: 100px;
        }
        .btn-primary:hover {
            background-color: #d07a7a;
        }
        .badge {
            font-size: 0.8em;
        }
        .actions-column {
            position: sticky;
            right: 0;
            background-color: #3b3b3b;
            z-index: 10;
        }
        .table tbody tr:hover .actions-column {
            background-color: #4a4a4a;
        }
        .nav-meses {
            background-color: #363636;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .nav-meses .btn {
            margin: 0 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Navegación entre meses -->
    <div class="nav-meses text-center">
        <a th:href="@{/cuotas/{(mesAnterior)}/{(anioAnterior)}}" class="btn btn-outline-primary">
            <i class="fas fa-chevron-left"></i> Mes Anterior
        </a>
        <span class="mx-3 fs-5 fw-bold" th:text="${nombreMes + ' ' + anioActual}">Octubre 2023</span>
        <a th:href="@{/cuotas/{(mesSiguiente)}/{(anioSiguiente)}}" class="btn btn-outline-primary">
            Mes Siguiente <i class="fas fa-chevron-right"></i>
        </a>
        <a th:href="@{/corredor/panel}" class="btn btn-primary ms-3">
            <i class="fas fa-chart-line me-1"></i>Panel Corredor
        </a>
    </div>

    <h2><i class="fas fa-file-invoice-dollar me-2"></i>
        Cuotas a Cobrar - <span th:text="${nombreMes}">Octubre</span> <span th:text="${anioActual}">2023</span>
    </h2>

    <!-- Alertas -->
    <div id="alertContainer"></div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" th:text="${cuotas.size()}">0</div>
                <div class="stats-label">TOTAL CUOTAS</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" th:text="'$' + ${#numbers.formatDecimal(totalMontoPendiente, 1, 2, 'COMMA')}">$0</div>
                <div class="stats-label">MONTO PENDIENTE</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-success" th:text="'$' + ${#numbers.formatDecimal(totalMontoPagado, 1, 2, 'COMMA')}">$0</div>
                <div class="stats-label">MONTO PAGADO</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number" th:text="${cuotasPagadas}">0</div>
                <div class="stats-label">CUOTAS PAGADAS</div>
            </div>
        </div>
    </div>

    <!-- Tabla de cuotas -->
    <div class="table-container">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>LOCATARIO</th>
                <th>PROPIEDAD</th>
                <th>PAGO DE ALQUILER</th>
                <th>FECHA DE VENCIMIENTO</th>
                <th>EXPENSAS</th>
                <th>SEGURO</th>
                <th>PRÓXIMO AUMENTO</th>
                <th>TIPO DE AJUSTE</th>
                <th>INFORMACION EXTRA</th>
                <th>ESTADO</th>
                <th class="actions-column">ACCIONES</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="cuota : ${cuotas}">
                <td th:text="${cuota.contrato.locatario.email}">giannapilar42@gmail.com</td>
                <td>
                    <strong th:text="${cuota.contrato.propiedad.direccion}">Dirección</strong><br>
                    <small class="text-muted" th:text="${cuota.contrato.propiedad.tipo}">Casa</small>
                </td>
                <td th:text="'$' + ${#numbers.formatDecimal(cuota.monto, 1, 2, 'COMMA')}">$255,612.00</td>
                <td th:text="${cuota.fechaVencimiento}">Del 1 al 10</td>
                <td>
                    <span th:if="${cuota.expensas != null}"
                          th:text="'$' + ${#numbers.formatDecimal(cuota.expensas, 1, 2, 'COMMA')}">$15,000.00</span>
                    <span th:unless="${cuota.expensas != null}" class="text-muted">-</span>
                </td>
                <td>
                    <span th:if="${cuota.contrato.seguro}" class="badge bg-success">SI</span>
                    <span th:unless="${cuota.contrato.seguro}" class="badge bg-danger">NO</span>
                </td>
                <td th:text="${cuota.contrato.proximoAumento}">16/12/2025</td>
                <td th:text="${cuota.contrato.tipoIndice}">ICL</td>
                <td>
                    <small th:text="${cuota.observaciones}" class="text-muted">sacar online</small>
                </td>
                <td>
                    <span th:switch="${cuota.estado}" class="badge">
                        <span th:case="PENDIENTE" class="badge bg-warning text-dark">PENDIENTE</span>
                        <span th:case="PAGADA" class="badge bg-success">PAGADA</span>
                        <span th:case="VENCIDA" class="badge bg-danger">VENCIDA</span>
                    </span>
                </td>
                <td class="actions-column">
                    <button th:if="${cuota.estado.name() == 'PENDIENTE'}"
                            class="btn btn-primary btn-sm"
                            th:onclick="|abrirModalPago('${cuota.contrato.locatario.email}', ${cuota.monto}, ${cuota.id})|">
                        <i class="fas fa-money-bill-wave me-1"></i>Abonar
                    </button>
                    <span th:if="${cuota.estado.name() == 'PAGADA'}" class="badge bg-success">PAGADO</span>
                </td>
            </tr>
            <tr th:if="${cuotas.empty}">
                <td colspan="11" class="text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-2x mb-2 text-success"></i><br>
                    No hay cuotas pendientes para <span th:text="${nombreMes}"></span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Pago (Mantener igual que en octubre.html) -->
<div class="modal fade" id="modalPago" tabindex="-1" aria-labelledby="modalPagoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPagoLabel">Registrar Pago</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Locatario:</label>
                    <input type="text" class="form-control" id="locatarioNombre" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label">Cuota Original:</label>
                    <input type="text" class="form-control" id="cuotaOriginal" readonly>
                </div>

                <!-- Descuentos -->
                <div class="mb-3">
                    <label class="form-label">Descuentos/Arreglos:</label>
                    <div id="descuentosContainer"></div>
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="agregarDescuento()">
                        <i class="fas fa-plus me-1"></i>Agregar Descuento
                    </button>
                </div>

                <div class="mb-3">
                    <label class="form-label">Total a Pagar:</label>
                    <input type="text" class="form-control" id="totalPagar" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">Método de Pago:</label>
                    <select class="form-select" id="metodoPago">
                        <option value="transferencia">Transferencia</option>
                        <option value="efectivo">Efectivo</option>
                    </select>
                </div>

                <!-- Distribución de fondos -->
                <div class="mb-3">
                    <label class="form-label">Distribución de Fondos:</label>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-control bg-dark text-white">
                                <strong>Corredor (10%):</strong> <span id="montoCorredor">$0.00</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-control bg-dark text-white">
                                <strong>Locador (90%):</strong> <span id="montoLocador">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="procesarPago()">
                    <i class="fas fa-file-invoice me-1"></i>Generar Factura
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Factura (Mantener igual) -->
<div class="modal fade" id="modalFactura" tabindex="-1" aria-labelledby="modalFacturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalFacturaLabel">Factura - DC Inmobiliaria</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="facturaContent" class="factura-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="imprimirFactura()">
                    <i class="fas fa-print me-1"></i>Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Variables globales
    let cuotaActual = 0;
    let cuotaIdActual = 0;
    let descuentos = [];
    let locatarioActual = '';

    // Función para abrir modal de pago ACTUALIZADA
    function abrirModalPago(locatario, cuota, cuotaId) {
        locatarioActual = locatario;
        cuotaActual = cuota;
        cuotaIdActual = cuotaId;
        descuentos = [];

        document.getElementById('locatarioNombre').value = locatario;
        document.getElementById('cuotaOriginal').value = '$' + cuota.toLocaleString('es-AR');
        document.getElementById('totalPagar').value = '$' + cuota.toLocaleString('es-AR');
        document.getElementById('descuentosContainer').innerHTML = '';

        calcularDistribucion();

        const modalPago = new bootstrap.Modal(document.getElementById('modalPago'));
        modalPago.show();
    }

    // Función procesarPago ACTUALIZADA
    function procesarPago() {
        const metodoPago = document.getElementById('metodoPago').value;
        const totalPagar = parseFloat(document.getElementById('totalPagar').value.replace('$', '').replace(/\./g, '').replace(',', '.')) || cuotaActual;

        // Recopilar descuentos
        const descuentosInfo = [];
        const conceptos = document.querySelectorAll('.descuento-concepto');
        const montos = document.querySelectorAll('.descuento-monto');

        let totalDescuentos = 0;
        for (let i = 0; i < conceptos.length; i++) {
            if (conceptos[i].value && montos[i].value) {
                const monto = parseFloat(montos[i].value) || 0;
                descuentosInfo.push({
                    concepto: conceptos[i].value,
                    monto: monto
                });
                totalDescuentos += monto;
            }
        }

        // Preparar datos para enviar
        const pagoData = {
            cuotaId: cuotaIdActual, // ¡Ahora tenemos el cuotaId real!
            monto: totalPagar,
            metodoPago: metodoPago.toUpperCase(),
            descuentos: totalDescuentos,
            observaciones: 'Pago procesado desde sistema web - ' + descuentosInfo.map(d => d.concepto).join(', ')
        };

        // Mostrar loading
        const boton = event.target;
        const textoOriginal = boton.innerHTML;
        boton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';
        boton.disabled = true;

        // Enviar al backend
        fetch('/cuotas/procesar-pago', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(pagoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('Pago procesado correctamente. ' +
                    (metodoPago === 'efectivo' ? 'Confirmado automáticamente.' : 'Transferencia pendiente de verificación.'),
                    'success');

                mostrarFactura(pagoData, data.numeroFactura, data.estado);
                actualizarEstadoPago(cuotaIdActual, data.estado);
            } else {
                mostrarAlerta('Error: ' + data.error, 'danger');
            }
            boton.innerHTML = textoOriginal;
            boton.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('Error al conectar con el servidor', 'danger');
            boton.innerHTML = textoOriginal;
            boton.disabled = false;
        });
    }

    // Mantener el resto de funciones JavaScript igual...

    // Función para mostrar alertas
    function mostrarAlerta(mensaje, tipo = 'success') {
        const alertContainer = document.getElementById('alertContainer');
        const alertHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                <i class="fas fa-${tipo === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        alertContainer.innerHTML = alertHTML;
    }

    // Las demás funciones (agregarDescuento, eliminarDescuento, actualizarTotal, etc.) se mantienen igual
</script>
</body>
</html>